// helper function for creating elements (usage optional)
function createElement(type, attrs, ...children) {
  const ele = document.createElement(type);

  // add element attributes
  for (const prop in attrs) {
    if (attrs.hasOwnProperty(prop)) {
      ele.setAttribute(prop, attrs[prop]);
    }
  }

  // add child nodes to element
  children.forEach(c => ele.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));

  return ele;
}

// TODO: finish client side javascript

// helper function for creating elements (usage optional)
function createElement(type, attrs, ...children) {
  const ele = document.createElement(type);

  // add element attributes
  for (const prop in attrs) {
    if (attrs.hasOwnProperty(prop)) {
      ele.setAttribute(prop, attrs[prop]);
    }
  }

  // add child nodes to element
  children.forEach(c => ele.appendChild(typeof c === 'string' ? document.createTextNode(c) : c));

  return ele;
}

document.addEventListener('DOMContentLoaded', async () => {
  try {
    const response = await fetch('/questions');
    const questions = await response.json();

    console.log(questions);

    // Handle the data and update the DOM
    const contentElement = document.getElementById('content');

    // Iterate through each question in the JSON response
    questions.forEach(question => {
      // Create elements for the question
      const questionElement = createElement('h2', null, question.question);

      // Create an unordered list for answers
      const answersList = createElement('ul');

      // Iterate through each answer in the question
      question.answers.forEach(answer => {
        // Create list item for each answer
        const answerItem = createElement('li', null, answer);

        // Append the answer item to the answers list
        answersList.appendChild(answerItem);
      });

      // Create a button to add an answer
      const addButton = createElement('button', { type: 'button' }, 'Add an Answer');
      addButton.addEventListener('click', () => {
        // Show the modal for adding an answer
        modalAnswer.style.display = 'block';
        // Set the question ID for the current question (for future reference)
        document.getElementById('question-id').value = question._id;
      });

      // Append question element, answers list, and add button to the content element
      contentElement.appendChild(questionElement);
      contentElement.appendChild(answersList);
      contentElement.appendChild(addButton);
    });

    // Implementation for "Ask a Question" button click
    const askButton = document.getElementById('btn-show-modal-question');
    const modalQuestion = document.getElementById('modal-question');
    const modalAnswer = document.getElementById('modal-answer');

    askButton.addEventListener('click', () => {
      // Show the modal for asking a question
      modalQuestion.style.display = 'block';
    });

    // Event listener for form submission in the ask question modal
    const questionForm = document.getElementById('modal-question');
    questionForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      // Collect the form data (just the question text)
      const questionText = document.getElementById('question-text').value;

      // Use AJAX POST to send the question text to the server
      try {
        const response = await fetch('http://localhost:3000/questions/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ question: questionText }),
        });

        const data = await response.json();

        // Handle successful result (add question text to the page, etc.)
        console.log(data);

        // Close the modal
        modalQuestion.style.display = 'none';
        // Clear the form
        questionForm.reset();
      } catch (error) {
        // Handle failure (log error, display error message, etc.)
        console.error('Error asking a question:', error);
      }
    });

    // Event listener for form submission in the add answer modal
    const answerForm = document.getElementById('modal-answer');
    answerForm.addEventListener('submit', async (event) => {
      event.preventDefault();

      // Collect the form data (just the answer text)
      const answerText = document.getElementById('answer-text').value;
      // Collect the question ID
      const questionId = document.getElementById('question-id').value;

      // Use AJAX POST to send the answer text to the server
      try {
        const response = await fetch(`http://localhost:3000/questions/${questionId}/answers/`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ answer: answerText }),
        });

        const data = await response.json();

        // Handle successful result (add answer text to the page, etc.)
        console.log(data);

        // Close the modal
        modalAnswer.style.display = 'none';
        // Clear the form
        answerForm.reset();
      } catch (error) {
        // Handle failure (log error, display error message, etc.)
        console.error('Error adding an answer:', error);
      }
    });

    // Add this inside your existing "Close" button event listener for the modals
    const closeQuestionButton = document.querySelector('#modal-question .close');
    closeQuestionButton.addEventListener('click', () => {
      // Hide the modal for asking a question
      modalQuestion.style.display = 'none';
      // Clear the form
      questionForm.reset();
    });

    const closeAnswerButton = document.querySelector('#modal-answer .close');
    closeAnswerButton.addEventListener('click', () => {
      // Hide the modal for adding an answer
      modalAnswer.style.display = 'none';
      // Clear the form
      answerForm.reset();
    });

  } catch (error) {
    console.log('Error fetching questions:', error);
    // Add more robust error handling if desired
  }
});




import './config.mjs'
import mongoose from 'mongoose'
import express from 'express'
import Question from './db.mjs'
import url from 'url'
import path from 'path'

const __dirname = path.dirname(url.fileURLToPath(import.meta.url))

const app = express()

app.use(express.static(path.join(__dirname, '..', 'public')))
app.use(express.json());

app.post('/questions/', async (req, res) => {
  try {
    const newQuestion = await Question.create({
      question: req.body.question,
      answers: [], 
    });

    res.json(newQuestion);
  } catch (error) {
    res.status(500).json({ error: 'Failed to create a new question' });
  }
});


app.post('/questions/:id/answers/', async (req, res) => {
  const update = { "$push": { answers: req.body.answer } }
  try {
    const result = await Question.findByIdAndUpdate(req.params.id, update, { "new": true })
    res.json({ success: 'Added an answer' })
  } catch(e) {
    res.status(500).json({ error: 'Failed to add answer' })
  }
})

app.get('/questions/', async (req, res) => {
  try {
    const questions = await Question.find({})
    res.json(questions); 
  } catch (error) {
    res.status(500).json({ error: 'Internal Server Error: Failed to get questions' }); 
  }
})


const port = process.env.PORT || 3000
app.listen(port, () => {console.log(`Server is listening on ${port}`)})




/////////////







